---
- hosts: localhost
  become: true
  gather_facts: no
  tasks:

  - name: Set variables
    include: include/_setup_vars.yaml

  - name: Set more memory
    shell: virsh setmem {{ hostname }}.{{ domain }} 16G --config

  - name: Start machine
    shell: virsh start {{ hostname }}.{{ domain }}
    ignore_errors: yes

- hosts: freeipa.lab.local
  become: true
  gather_facts: no
  tasks:

  - name: Set variables
    include: include/_setup_vars.yaml

  - name: Login to ipa
    shell: echo "{{ adminpwd }}" | kinit admin

  - name: Add DNS record for host
    shell: ipa dnsrecord-add {{ domain }} {{ hostname }} --a-rec {{ ip }}
    ignore_errors: yes

- hosts: centos7
  become: true
  gather_facts: no
  tasks:

  - pause:
      seconds: 25

  - name: Set variables
    include: include/_setup_vars.yaml

  - name: Change hostname
    shell: echo "{{ hostname }}.{{ domain }}" > /etc/hostname

  - name: Add hosts to hostname
    shell: echo "{{ ip }} {{ hostname }} {{ hostname }}.{{ domain }}" >> /etc/hosts

  - name: Resize partition
    shell: printf 'd\n2\np\nn\np\n2\n\n\nt\n2\n8e\nw' | fdisk /dev/sda
    ignore_errors: yes

  - name: Partprobe disks
    shell: partprobe /dev/sda

  - name: PV resize
    shell: pvresize /dev/sda2

  - name: LV extend /lv-var
    shell: lvresize /dev/rootvg/var -L+20G

  - name: Resize fs 
    shell: resize2fs /dev/rootvg/var

  - name: Add an Ethernet connection with static IP configuration - add ipa server client
    shell: nmcli connection modify eth0 ipv4.addresses {{  ip  }}/24 ipv4.method manual ipv4.dns "10.1.8.10"

  - name: Change strict policy on ssh client
    shell: echo "StrictHostKeyChecking no" >> /etc/ssh/ssh_config

  - name: Make gshipley directory
    shell: mkdir /root/gshipley
  
  - name: Copy gshipley
    copy:
      src: /root/bitbucket/private/lab/temp/gshipley.tgz
      dest: /root/gshipley/gshipley.tgz
      mode: 644

  - name: extract gshipley
    shell: cd /root/gshipley ; tar xvfz ./gshipley.tgz

  - name: Run prepare script
    shell: cd /root/gshipley ; ./prepare-install.sh

  - name: Copy inventory.ini
    copy:
      src: /root/bitbucket/private/lab/03_okdv3/gshipley/inventory.ini
      dest: /root/gshipley/cluster.ini
      mode: 644



- hosts: localhost
  become: true
  gather_facts: no
  tasks:

  - name: Shutdown the vm
    shell: virsh shutdown {{ hostname }}.{{ domain }}

