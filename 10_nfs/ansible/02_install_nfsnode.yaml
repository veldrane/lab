---
- hosts: localhost
  become: true
  gather_facts: no
  tasks:

  - name: Set variables
    include: include/_setup_vars.yaml

  - name: "Create ansible group for new hosts"
    add_host: name="{{ ip }}" groups=newhost

  - name: Create nfs home data disk
    shell: qemu-img create -f qcow2 {{ vms_dir }}/{{ fqdn }}/nfsvg.qcow2 {{ disksize }}

  - name: Attach disk to machine
    shell: virsh attach-disk {{ fqdn }} --source {{ vms_dir }}/{{ fqdn }}/nfsvg.qcow2 --target vdb --subdriver qcow2 --targetbus virtio --persistent

  - name: Autostart of the machine
    shell: virsh autostart {{ fqdn }}

- hosts: newhost
  become: true
  gather_facts: no
  tasks:

  - name: Set variables
    include: include/_setup_vars.yaml

  - name: Setup firewall rules
    shell: firewall-cmd --permanent --add-service={mountd,nfs,rpc-bind} ; firewall-cmd --reload

  - name: Install prerequisites
    shell: yum install -y nfs-utils policycoreutils-python-2.5-33.el7.x86_64

  - name: Create datavg and logical volume
    shell: pvcreate /dev/vdb ; vgcreate nfsvg /dev/vdb ; lvcreate -n home -L20G nfsvg

  - name: Create fs
    shell: mkfs.ext4 /dev/nfsvg/home

  - name: make directory /nfsvg/home
    shell: mkdir -p /nfsvg/home

  - name: Add /nfshome to fstab
    shell: echo '/dev/mapper/nfsvg-home  /nfsvg/home              ext4    noatime,nodiratime        1 2' >> /etc/fstab

  - name: Mount /nfsvg/home
    shell: mount /nfsvg/home

  - name: Set selinux context 
    shell: semanage fcontext -a -t nfs_t "/nfsvg(/.*)?" ; restorecon -Rv /nfsvg/

  - name: Get the krb5 ticket
    shell: echo "{{ adminpwd }}" | kinit {{ svcadmin }}

  - name: Add nfs service
    shell: ipa service-add nfs/{{ fqdn }}@{{ realm }} --force

  - name: Get host keytab
    shell: ipa-getkeytab  -p host/{{ fqdn }} -k /etc/krb5.keytab

  - name: Get nfs keytab
    shell: ipa-getkeytab  -p nfs/{{ fqdn }} -k /etc/krb5.keytab

  - name: Set nfs exports 
    shell: echo '/nfsvg/home *(rw,sec=krb5p,sync)' >> /etc/exports ; exportfs -r

  - name: Enable and start nfs services
    shell: systemctl start nfs-server ; systemctl enable nfs-server

  - name: Enable and start nfs secure services
    shell: systemctl start nfs-secure ; systemctl enable nfs-secure
